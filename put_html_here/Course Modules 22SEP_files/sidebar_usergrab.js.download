//var urlPath = window.location.href;
/*
 var refUrlPath = document.referrer;
 //console.log('referred from ' + refUrlPath);
 if (refUrlPath==null || refUrlPath==''){
 var urlPath = window.location.href;
 } else {
 var urlPath = refUrlPath;
 }
 */

//Click event for viewing submitted issues.
$('body').on('click', ".view-submitted-issues", function (e) {
    //console.log('View Submitted Issues Clicked!');
    /*ADD SUBMITTED ISSUES SCRIPT*/
    modalTitle = 'View Submitted Issues';
    modalWindow = '<div class="course-item-container"><div class="section"><div class="section-content"></div><div class="cirt_container cirt-curpage-view"><div class="center"><i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span><span>Loading...</span></div></div></div></div></div></div>';
    viewSubmitted(function (data) {
        $('.cirt_container').html(data);
    });
    cirtModal(modalTitle, modalWindow);
    e.preventDefault();
});

//Click event for reporting an issue
$('body').on('click', ".report-an-issue", function (e) {
    //console.log('Report and Issue Clicked!');
    /*ADD REPORT AN ISSUE SCRIPT*/
    modalTitle = 'Report an Issue';
    modalWindow = '<div class="course-item-container"><div class="section"><div class="section-content"><div></div><div class="cirt_container cirt-curpage-submit"><div class="center"><i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span><span>Loading...</span></div></div><div class="cirt_sub_btns"><a class="button btn btn-primary cirt_submission_btn">Submit</a></div></div></div></div>';
    reportIssue(function (data) {
        $('.cirt_container').html(data);
    });
    cirtModal(modalTitle, modalWindow);
    e.preventDefault();
});

//Click event for help
$('body').on('click', ".help", function (e) {
    //console.log('Report and Issue Clicked!');
    /*ADD REPORT AN ISSUE SCRIPT*/
    modalTitle = 'Help';
    modalWindow = '<p>CIRT, the Course Issue Reporting Tool, replaces Sidebar as the place to report issues with course content. If you find an issue on any page in your course, just open Faculty Tools and select Report an Issue</p><p>CIRT will automatically detect your identity and the course you are in.</p><p>It will also capture the week and page you currently have open. (If you wish to change the week and page for your issue report, you may use the dropdown to select a different page. You will see a list of all weeks and all pages within each week. Just click on the correct one to select it.)</p><p>Provide a Title for the Issue, a description of the issue, and an Importance flag (if you wish). You may also add an attachment if you wish to provide additional documentation.</p><p><img src="https://lms.courselearn.net/lms/CourseExport/manual/images/CIRT/image/CIRT_Help1.jpg" alt="Fields indicated in the step above for CIRT." /></p><p>Click Submit.</p><p>You will receive a confirmation.</p><p><img src="https://lms.courselearn.net/lms/CourseExport/manual/images/CIRT/image/CIRT_Help2.jpg" alt="Confirmation message based on the step above for CIRT." /></p><p>You may close the CIRT window.</p><p>To review reported issues, open Faculty Tools and select View Submitted Issues from the CIRT section.</p><p><img src="https://lms.courselearn.net/lms/CourseExport/manual/images/CIRT/image/CIRT_Help3.jpg" alt="Visual depicting clicking on View Submitted Issues." /></p><p>You will see all of the items that have been reported for this course.</p><img src="https://lms.courselearn.net/lms/CourseExport/manual/images/CIRT/image/CIRT_Help4.jpg" alt="List of items that have been reported for the course" /></p>';
    cirtModal(modalTitle, modalWindow);
    e.preventDefault();
});

//Variable declaration
var course_data;
var user_data;
var courseCode;
var urlPath = window.location.href;
var splitPath = urlPath.split('/');
var cid = splitPath[4];
var curbrowser = 'Unknown Browser';
//var canvasDomain = urlPath[2];
//console.log(cid);

onVarAvailable(["CanvasDetails",'courseInfo'], function () {
    console.log('Canvas Details are now available');
    course_data = CanvasDetails.courseInfo;
    user_data = CanvasDetails.userInfo;

    if (course_data != '' && course_data != null && course_data != "undefined") {
        var trayLinks = [{
                key: '#',
                val: 'View Submitted Issues'
            }, {
                key: '#',
                val: 'Report an Issue'
            }, {
                key: '#',
                val: 'Help'
            }];
        var slide_out_title = "Faculty Tools"; //Changes the title on the slide out menu
        var global_nav_name = "Faculty Tools"; //Change the title on the global navigation menu
        var footerContent = ''; //Changes the text of the bottom on the slide out tray

        reactTray(trayLinks, slide_out_title, global_nav_name, footerContent);
        
        //var userID = user_data.id;
        //var userEmail = user_data.primary_email;
        courseCode = course_data.course_code;
        //var dnumber = user_data.sis_user_id;
        var cirt_frontpage = '';
        var cirt_submitpage = '';
        var cirt_viewpage = '';
        var user_shortname = user_data.name.split(" ");
        user_shortname = user_shortname[0];
        //var courseSession = user_data.name.split(" - ");
        //console.log(courseSession);
        //courseSession = courseSession[courseSession.length-1];
        /*
        if (courseSession.search(/\w{3}\d{2}/ig) < 0) {
            courseSession == null;
        }
        */
             
	/*GRABBING BROWSER TYPE*/
	var userAgent = navigator.userAgent;
	var palemoon = /PaleMoon\/(\d+\.\d+)/ig;
	var firefox = /Firefox[\/\s](\d+\.\d+)/ig;
	var old_ie = /MSIE (\d+\.\d+)/ig;
	var new_ie = /Trident.*rv[ :]*(\d+\.\d+)/ig;
	var old_opera = /Opera[\/\s](\d+\.\d+)/ig;
	var new_opera = /OPR\/(\d+\.\d+)/ig; 
	var chrome = /Chrome\/(\d+\.\d+)/ig;
	var old_safari = /Safari\/(\d+\.\d+)/ig;
	var new_safari = /Version\/(\d+\.\d+)/ig;
			
	//Browser testing
	//Test if old Opera
	if (old_opera.test(userAgent)==true) {
            if(userAgent.indexOf('Version')!=-1){
                curbrowser = userAgent.match(new_safari)[0].replace('Version','Opera').replace('/',' ');
            } else {
                curbrowser = userAgent.match(old_opera)[0].replace('/',' ');
            }
            //Test if new Opera
        } else if (userAgent.indexOf('OPR/')!=-1){
            curbrowser = userAgent.match(new_opera)[0].replace('OPR','Opera').replace('/',' ');
            //Test if PaleMoon
	} else if (userAgent.indexOf('PaleMoon')!=-1){
            curbrowser = userAgent.match(palemoon)[0].replace('/',' ');
            //Test if Firefox
        } else if (firefox.test(userAgent)==true){
            curbrowser = userAgent.match(firefox)[0].replace('/',' ');
            //Test if IE
        } else if (userAgent.indexOf('MSIE')!=-1){
            curbrowser = userAgent.match(old_ie)[0].replace('MSIE','Internet Explorer');
            //Test if NEW IE
        } else if (new_ie.test(userAgent)==true){
            curbrowser = userAgent.match(new_ie)[0].replace(/Trident.*rv[ :]*/,'Internet Explorer ');
            //Test if Chrome	
        } else if (userAgent.indexOf('Chrome')!=-1) {
            curbrowser = userAgent.match(chrome)[0].replace('/',' ');
            //Test if Safari	
        } else if (userAgent.indexOf('Safari')!=-1) {
            if(userAgent.indexOf('Version')!=-1){
                curbrowser = userAgent.match(new_safari)[0].replace('Version','Safari').replace('/',' ');
            } else {
                curbrowser = userAgent.match(old_safari)[0].replace('/',' ');
            }
        }
        //$("#cirt_submit_form").find("input[name='browser']").eq(0).val(curbrowser);
	//$("#cirt_submit_form").find("input[name='browser']").eq(0).value = curbrowser;
        
        $.ajax({
            url: "/api/v1/users/self/profile",
            dataType: 'json',
            success: function (data) {
                console.log('Successfully connected to Canvas user data');
                userID = data.id;
                dnumber = data.sis_user_id;
                username = data.name;
                userEmail = data.primary_email;
            },
            error: function(errordata) {
                console.log('Failed to connect to Canvas user data');
                console.log(errordata);
            }
        });

        $("body").off('click', '.cirt_submission_btn').on('click', '.cirt_submission_btn', function () {
            //$("body").off('click', '.cirt_submission_btn');
            $("#cirt_submit_form").find("input[name='browser']").eq(0).val(curbrowser);
            $("#cirt_submit_form").find("input[name='browser']").eq(0).value = curbrowser;
            
            var formdata = new FormData($("#cirt_submit_form")[0]);
            
            if ($("#cirt_submit_form").find("textarea[name='issue']").val() && $("#cirt_submit_form").find("textarea[name='issue']").val().trim() != '') {
                //console.log('clicked submit button');
                $(".cirt_container").html('<div class="center"><i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Submitting...</span>&nbsp;Submitting...</div>');
                $(".cirt_sub_btns").css("display", "none");
                $.ajax({
                    type: "POST",
                    url: "https://lms.courselearn.net/lms/scripts/php/sidebar.php",
                    processData: false,
                    contentType: false,
                    // data: $("#cirt_submit_form").serialize(),
                    data: formdata,
                    /*
                     data: {
                     userid: $("#cirt_submit_form").find("input[name='userid']").val(),
                     currentcourse: $("#cirt_submit_form").find("input[name='currentcourse']").val(),
                     week: $("#cirt_submit_form").find("select[name='week']").val(),
                     location: $("#cirt_submit_form").find("input[name='location']").val(),
                     summary: $("#cirt_submit_form").find("input[name='summary']").val(),
                     dsi: $("#cirt_submit_form").find("input[name='dsi']").val(),
                     email: $("#cirt_submit_form").find("input[name='email']").val(),
                     label: $("#cirt_submit_form").find("select[name='label']").val(),
                     issue: $("#cirt_submit_form").find("textarea[name='issue']").val(),
                     fileattach: $("#cirt_submit_form").find("input[name='fileattach']").val()
                     },
                     */
                    success: function () {
                        //console.log('passed formdata ok');
                        $("#cirt_submit_form").find("textarea[name='issue']").css("border-color", "#d8e0e6");
                        $(".cirt_container").html("<h1>Thank you for your submission, " + user_shortname + "!</h1>");
                        $(".cirt_sub_btns").css("display", "none");
                        $(".cirt_front_btns").css("display", "none");
                        $(".cirt_action_btns").css("display", "block");
                        console.log('submitted successfully');
                        console.log(formdata);
                    },
                    error: function(errordata){
                        console.log('error: ');
                        console.log(errordata);
                        $('.cirt_container').html('Error: This ticket has not submitted properly. If you are using Safari, please try submitting the ticket with Firefox instead.<br />' + errordata);
                    }
                });
            } else {
                $("#cirt_submit_form").find("textarea[name='issue']").css("border-color", "red");
                $("#cirt_submit_form").find("textarea[name='issue']").addClass('has-warning');
            }
        });
    }
})

function viewSubmitted(callback) {
    onVarAvailable(["userID"], function () {
        console.log('userID is available');
        $.ajax({
            url: "https://lms.courselearn.net/lms/scripts/php/sidebar.php?userid=" + userID + "&urlpath=" + urlPath,
            async: true,
            success: function (phpdata) {
                callback(phpdata);
                //$(".cirt_container").html(phpdata);
            },
            error: function(errordata){
                console.log('Failed to view submitted issues');
                console.log(errordata);
            }
        });
    });
}

function reportIssue(callback) {
    onVarAvailable(["userID"], function () {
        console.log('userID is available');
        console.log(courseCode+", "+userEmail+", "+userID+", "+cid+", "+urlPath+", "+curbrowser);
        $.ajax({
            url: "https://lms.courselearn.net/lms/scripts/php/sidebar.php?action=submit&course=" + courseCode + "&name=" + username + "&dsi=" + dnumber + "&useremail=" + userEmail + "&userid=" + userID + "&cid=" + cid + "&urlpath=" + urlPath + "&browser=" + curbrowser,
            async: true,
            success: function (phpdata) {
                callback(phpdata);
            //$(".cirt_container").html(phpdata);
            }, 
            error: function(errordata){
                console.log('Failed to submit issue');
		console.log(errordata);					}
        });
    });
}
        